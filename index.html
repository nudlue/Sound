<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì‹¤ì‹œê°„ ì˜¤ë””ì˜¤ ë¶„ë¥˜ (Teachable Machine)</title>

  <!-- TensorFlow.js & Speech Commands -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/speech-commands"></script>

  <style>
    body { font-family: "Noto Sans KR", sans-serif; margin: 30px; }
    h1 { margin-bottom: 20px; }
    button { font-size: 16px; padding: 10px 18px; margin-right: 10px; }
    table { margin-top: 20px; border-collapse: collapse; width: 380px; }
    th, td { border: 1px solid #ccc; padding: 10px 14px; }
    #status { margin-top: 15px; font-weight: bold; }
  </style>
</head>

<body>

<h1>ğŸ¤ ì‹¤ì‹œê°„ ì˜¤ë””ì˜¤ ë¶„ë¥˜</h1>

<button id="startBtn">ì‹¤ì‹œê°„ ë¶„ì„ ì‹œì‘</button>
<button id="stopBtn" disabled>ì¤‘ì§€</button>

<p id="status">ìƒíƒœ: ëŒ€ê¸° ì¤‘</p>

<table id="resultTable">
  <thead>
    <tr>
      <th>í´ë˜ìŠ¤</th>
      <th>í™•ë¥  (%)</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
let recognizer = null;
let isListening = false;

// ëª¨ë¸ íŒŒì¼ ìœ„ì¹˜
const MODEL_URL = "./model.json";
const METADATA_URL = "./metadata.json";

const statusEl = document.getElementById("status");
const startBtn = document.getElementById("startBtn");
const stopBtn = document.getElementById("stopBtn");
const resultTable = document.getElementById("resultTable");
const resultBody = resultTable.querySelector("tbody");

// --- ëª¨ë¸ ë¡œë“œ ---
async function loadModel() {
  statusEl.innerText = "ìƒíƒœ: ëª¨ë¸ ë¡œë“œ ì¤‘...";
  try {
    recognizer = await speechCommands.create(
      "BROWSER_FFT",
      undefined,
      MODEL_URL,
      METADATA_URL
    );
    await recognizer.ensureModelLoaded();
    statusEl.innerText = "ìƒíƒœ: ëª¨ë¸ ë¡œë“œ ì™„ë£Œ!";
  } catch (err) {
    console.error(err);
    statusEl.innerText = "ìƒíƒœ: ëª¨ë¸ ë¡œë“œ ì‹¤íŒ¨(ì½˜ì†” í™•ì¸)";
  }
}
loadModel();

// --- ì‹¤ì‹œê°„ ë¶„ì„ ì‹œì‘ ---
startBtn.onclick = async () => {
  if (!recognizer) return;

  try {
    await recognizer.listen(result => {
      const scores = result.scores;
      const labels = recognizer.wordLabels();

      updateTable(scores, labels);
    }, {
      includeSpectrogram: false,
      probabilityThreshold: 0,
      overlapFactor: 0.5
    });

    isListening = true;
    statusEl.innerText = "ìƒíƒœ: ì‹¤ì‹œê°„ ë¶„ì„ ì¤‘â€¦";
    startBtn.disabled = true;
    stopBtn.disabled = false;
  } catch (err) {
    console.error(err);
    statusEl.innerText = "ìƒíƒœ: ë¶„ì„ ì‹œì‘ ì˜¤ë¥˜(ì½˜ì†” í™•ì¸)";
  }
};

// --- ì‹¤ì‹œê°„ ë¶„ì„ ì¤‘ì§€ ---
stopBtn.onclick = () => {
  if (!recognizer || !isListening) return;

  recognizer.stopListening();
  isListening = false;

  statusEl.innerText = "ìƒíƒœ: ì¤‘ì§€ë¨";
  startBtn.disabled = false;
  stopBtn.disabled = true;
};

// --- í…Œì´ë¸” ì—…ë°ì´íŠ¸ ---
function updateTable(scores, labels) {
  resultBody.innerHTML = "";
  scores.forEach((score, i) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${labels[i]}</td>
      <td>${(score * 100).toFixed(2)}%</td>
    `;
    resultBody.appendChild(tr);
  });
}
</script>
</body>
</html>
